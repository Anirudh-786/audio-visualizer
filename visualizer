const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");
const statusText = document.getElementById("status");

startBtn.onclick = async () => {
  try {
    statusText.innerText = "Requesting microphoneâ€¦";

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioCtx = new AudioContext();

    const analyser = audioCtx.createAnalyser();
    const source = audioCtx.createMediaStreamSource(stream);

    source.connect(analyser);
    analyser.fftSize = 256;

    const data = new Uint8Array(analyser.frequencyBinCount);

    statusText.innerText = "Visualizer running ðŸŽ¤";

    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const cx = 250, cy = 250, r = 100;

      for (let i = 0; i < data.length; i++) {
        const angle = (i / data.length) * Math.PI * 2;
        const len = r + data[i];

        ctx.beginPath();
        ctx.moveTo(
          cx + Math.cos(angle) * r,
          cy + Math.sin(angle) * r
        );
        ctx.lineTo(
          cx + Math.cos(angle) * len,
          cy + Math.sin(angle) * len
        );
        ctx.strokeStyle = `hsl(${i * 3},100%,60%)`;
        ctx.stroke();
      }
    }

    draw();
  } catch (e) {
    statusText.innerText = "Microphone permission denied âŒ";
  }
};
